---
title: "Script immobile"
author: "Sacha PICCON"
date: "04/11/2019"
output: html_document
---

```{r}
load("allgre.PB_V2.RData")
library(tidyverse)
allgre.PB_V2 %>% distinct(id_pers,.keep_all = TRUE)-> allgreI
```


```{r}
allgreI$nbd
allgreI$nbd==0 ->immobile
library(dummies)
dummy(immobile) -> immobile
```
```{r}
cbind(allgreI, immobile) -> allgreI
allgreI %>% select(immobileTRUE, age, VP_DISPO, etabscol, jourdepl) -> mobilite
mobilite<-mobilite %>% rename("immobile"="immobileTRUE")
# On supprime les indvidus âgés de moins de 5 ans car automatiquement considérés comme personnes immobiles dans l'enquête
mobilite <- mobilite %>% filter(age > 4)
```

```{r}
mobilite$immobile <- factor(mobilite$immobile)
mobilite$VP_DISPO <- factor(mobilite$VP_DISPO)
```

```{r}
# Construction variable dernier établissement scolaire fréquenté (approximation niveau de diplôme obtenu)
mobilite$etabscol <-as.character(mobilite$etabscol) 
mobilite$etabscol[mobilite$etabscol %in% "8"]<-"PAS D'ETUDES"
mobilite$etabscol[mobilite$etabscol%in% "7"]<-"APPRENTISSAGE"
mobilite$etabscol[mobilite$etabscol%in% "6"]<-"Bac + 3 et plus"
mobilite$etabscol[mobilite$etabscol%in% "5"]<-"Bac + 1-2"
mobilite$etabscol[mobilite$etabscol%in% c("2", "3", "4")]<-"SECONDAIRE"
mobilite$etabscol[mobilite$etabscol%in% "1"] <-"PRIMAIRE"
mobilite$etabscol[mobilite$etabscol%in% "0" ]<-"EN COURS DE SCOLARITE"
mobilite$etabscol <-as.factor(mobilite$etabscol)
table(mobilite$etabscol)
summary(mobilite)

# Construction variable jour de la semaine
mobilite$jourdepl <-as.character(mobilite$jourdepl) 
mobilite$jourdepl[mobilite$jourdepl %in% "1"]<-"Lundi"
mobilite$jourdepl[mobilite$jourdepl %in% "2"]<-"Mardi"
mobilite$jourdepl[mobilite$jourdepl %in% "3"]<-"Mercredi"
mobilite$jourdepl[mobilite$jourdepl %in% "4"]<-"Jeudi"
mobilite$jourdepl[mobilite$jourdepl %in% "5"]<-"Vendredi"
mobilite$jourdepl <-as.factor(mobilite$jourdepl)
table(mobilite$jourdepl)
summary(mobilite)
```

```{r}
#Construction variable "statut de la mobilité" puis sélection des variables d'intérêt
mob<-factor(mobilite$immobile, levels = c("0","1"), labels = c("mobile","immobile"))
mobilite %>% cbind(mob)->mobilite
mobilite %>% select(mob, age, VP_DISPO, etabscol, jourdepl) %>% 
  rename("immobile"="mob")->mobilite

#créer une variable mobilité numérique
allgreI %>% filter(age > 4) %>% select(immobileTRUE)->mob3
cbind(mobilite, mob3)->mobilite
mobilite %>% 
  rename("immobile2"="immobileTRUE")->mobilite
```

```{r}
#Elaboration des statistiques descriptives
summary(mobilite)
#Part des personnes immobiles dans l'échantillon
mobilite %>% 
  mutate(VP_DISPO1=as.numeric(as.character(VP_DISPO)))->mobilite
summary(mobilite)

#construction d'une table indiquant la proportion de personnes immobiles en fonction du nombre de véhicule disponibles

mobilite %>% 
  filter(VP_DISPO==0) %>% 
  mutate(part_immobile0=sum(immobile2)/633)->immobile0
mobilite %>% 
  filter(VP_DISPO==1) %>% 
  mutate(part_immobile0=sum(immobile2)/2599)->immobile1
mobilite %>% 
  filter(VP_DISPO==2) %>% 
  mutate(part_immobile0=sum(immobile2)/3700)->immobile2
mobilite %>% 
  filter(VP_DISPO==3) %>% 
  mutate(part_immobile0=sum(immobile2)/673)->immobile3
mobilite %>% 
  filter(VP_DISPO==4) %>% 
  mutate(part_immobile0=sum(immobile2)/159)->immobile4
mobilite %>% 
  filter(VP_DISPO==5) %>% 
  mutate(part_immobile0=sum(immobile2)/2)->immobile5
rbind(immobile0,immobile1)->immobile1
rbind(immobile1, immobile2)->immobile2
rbind(immobile2, immobile3)->immobile3
rbind(immobile3, immobile4)->immobile4
rbind(immobile4, immobile5)->immobile5
mobilite %>% 
 arrange(VP_DISPO)->mobilite
immobile5 %>% 
  select(part_immobile0)->immobile5
mobilite %>% 
  cbind(immobile5)->mobilite

#construction d'une table indiquant la proportion de personnes immobiles en fonction du dernier niveau d'études suivi

mobilite %>% 
  filter(etabscol %in% "APPRENTISSAGE") %>% 
  mutate(prop_imm_scol=sum(immobile2)/24)->immobile0
mobilite %>% 
  filter(etabscol %in% "Bac + 1-2") %>% 
  mutate(prop_imm_scol=sum(immobile2)/709)->immobile1
mobilite %>% 
  filter(etabscol %in% "Bac + 3 et plus") %>% 
  mutate(prop_imm_scol=sum(immobile2)/1285)->immobile2
mobilite %>% 
  filter(etabscol %in%  "EN COURS DE SCOLARITE") %>% 
  mutate(prop_imm_scol=sum(immobile2)/1879)->immobile3
mobilite %>% 
  filter(etabscol %in%  "PAS D'ETUDES") %>% 
  mutate(prop_imm_scol=sum(immobile2)/25)->immobile4
mobilite %>% 
  filter(etabscol %in% "PRIMAIRE") %>% 
  mutate(prop_imm_scol=sum(immobile2)/413)->immobile5
mobilite %>% 
  filter(etabscol %in% "SECONDAIRE") %>% 
  mutate(prop_imm_scol=sum(immobile2)/2971)->immobile6
rbind(immobile0,immobile1)->immobile1
rbind(immobile1, immobile2)->immobile2
rbind(immobile2, immobile3)->immobile3
rbind(immobile3, immobile4)->immobile4
rbind(immobile4, immobile5)->immobile5
rbind(immobile5, immobile6)->immobile6
mobilite %>% 
 arrange(etabscol)->mobilite
immobile6 %>% 
  select(prop_imm_scol)->immobile6
mobilite %>% 
  cbind(immobile6)->mobilite

#Construction d'une table indiquant la proportion de personnes immobiles en fonction du jour de la semaine
mobilite %>% 
  filter(jourdepl %in% "Jeudi") %>% 
  mutate(prop_imm_jour=sum(immobile2)/1246)->immobile0
mobilite %>% 
  filter(jourdepl %in% "Lundi") %>% 
  mutate(prop_imm_jour=sum(immobile2)/1494)->immobile1
mobilite %>% 
  filter(jourdepl %in% "Mardi") %>% 
  mutate(prop_imm_jour=sum(immobile2)/1738)->immobile2
mobilite %>% 
  filter(jourdepl %in% "Mercredi") %>% 
  mutate(prop_imm_jour=sum(immobile2)/1475)->immobile3
mobilite %>% 
  filter(jourdepl %in% "Vendredi") %>% 
  mutate(prop_imm_jour=sum(immobile2)/1353)->immobile4
rbind(immobile0,immobile1)->immobile1
rbind(immobile1, immobile2)->immobile2
rbind(immobile2, immobile3)->immobile3
rbind(immobile3, immobile4)->immobile4
mobilite %>% 
 arrange(jourdepl)->mobilite
immobile4 %>% 
  select(prop_imm_jour)->immobile4
mobilite %>% 
  cbind(immobile4)->mobilite
```
16.44% de personnes sont immobiles 

```{r}
# Découpage de la variable âge en plusieurs classes
table(cut(mobilite$age, breaks= c(4, 17, 29, 39, 49, 59, 69, 100), useNA = "always"))
classage <-  cut(mobilite$age, breaks= c(4, 17, 29, 39, 49, 59, 69, 100), useNA = "always") 
mobilite %>% cbind(classage)
```
```{r}
#Construction de graphiques
mobilite %>% 
  ggplot(aes(immobile))+geom_bar()+labs(title = "nombre de personnes immobiles") + xlab("statut") + ylab("nombre de personnes")
#mobilite %>% ggplot(aes(immobile, color=immobile))+geom_()

#l'immobilité en fonction des véhicules disponibles

mobilite %>% 
  ggplot(aes(VP_DISPO, color=immobile))+geom_bar()+labs(title = "Caractère de la mobilité selon le nombre de véhicules personnels au sein du ménage") + xlab("Nombre de véhicules") + ylab("Nombre de personnes")
mobilite %>% 
  ggplot(aes(VP_DISPO, part_immobile0))+geom_point()+labs(title = "part des personnes immobiles selon le nombre de véhicules personnels au sein du ménage") + xlab("Nombre de véhicules") + ylab("Proportion de personnes immobiles")

#L'immobilité en fonction de l'âge

mobilite %>% 
  ggplot(aes(classage, color=immobile))+geom_bar()+labs(title = "nombre de personnes immobiles par classe d'âge") + xlab("classe d'âge") + ylab("nombre de personnes")
mobilite %>% 

 # L'immobilité en fonction du dernier niveau d'études suivi
  
ggplot(aes(etabscol, color=immobile))+geom_bar()+labs(title = "nombre de personnes immobiles selon le niveau d'études") + xlab("niveau d'études") + ylab("nombre de personnes")
mobilite %>% 
  ggplot(aes(etabscol, prop_imm_scol))+geom_point()+labs(title = "part des personnes immobiles selon le niveau d'études") + xlab("Niveau d'études") + ylab("Proportion de personnes immobiles")

# L'immobilité en fonction du jour de la semaine
mobilite %>% 
ggplot(aes(jourdepl, color=immobile))+geom_bar()+labs(title = "nombre de personnes immobiles selon le jour de la semaine") + xlab("jour") + ylab("nombre de personnes")
mobilite %>% 
ggplot(aes(jourdepl, prop_imm_jour))+geom_point()+labs(title = "Part des personnes immobiles selon le jour de la semaine") + xlab("Jour") + ylab("Proportion de personnes immobiles")
```
L'augmentation du nombre de véhicule disponible a tendance à réduire l'immobilité

On constate que plus le dernier niveau d'études suivi est avancé, plus la proportion d'immobiles est faible : confirmation intuition de la revue de la littérature.

On constate que la proportion de personnes immobiles est plus élevé le lundi et le mercredi
```{r}
#Construction des modèles
#Commençons avec un modèle de régression linéaire multiple
immobilite<-lm(immobile2~VP_DISPO+age, data = mobilite)
summary(immobilite)
#Un modèle logit semble plus adéquate que la régression linéaire
immobilite2<-glm(immobile2~VP_DISPO+age, data=mobilite, family = binomial("probit"))
summary(immobilite2)
immobilite3<-glm(immobile2~VP_DISPO+age, data = mobilite, family = binomial("logit"))
summary(immobilite3)
#Calcul des Odds ratio
exp(coefficients(immobilite3))
#Les effets marginaux (erreurs)
betas<-t(data.frame(coef(immobilite3))) ; betas
xmean <- c(1, mean(as.numeric(mobilite$VP_DISPO)-1), mean(mobilite$age))
xmean
print("XBetas:")
xb_logit <- sum(xmean*betas) ; xb_logit
# Slopes (at mean): Lambda(mean(xb))*(b)
print("Slopes:")
logit_slopes <- dlogis(xb_logit)*betas ; logit_slopes
#Quelques tests
library(aod)
```

I)Introduction
#II revue de la littérature
III) Les données
IV) Le modèle
V)Conclusion
